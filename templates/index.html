<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PYDUINO 대시보드</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
    <!-- 헤더 -->
    <header class="header">
        <span>PYDUINO</span>
        <span id="display-time">{{ display_date }}</span>
    </header>

    <!-- 상단 카드 -->
    <section class="info-cards">
        <div class="card">
            <h3>온도</h3>
            <p id="arduino-temp" class="value arduino">--°C</p>
            <p id="kma-temp" class="value kma">--°C</p>
        </div>
        <div class="card">
            <h3>습도</h3>
            <p id="arduino-hum" class="value arduino">--%</p>
            <p id="kma-hum" class="value kma">--%</p>
        </div>
        <div class="card">
            <h3>기압</h3>
            <p id="arduino-pressure" class="value arduino">-- hPa</p>
            <p id="kma-pressure" class="value kma">-- hPa</p>
        </div>
    </section>

    <!-- 탭  온도와 습도만 표시 -->
    <div class="bar">
        <div class="tabs" id="tabs">
            <button class="tab active" data-category="temperature">온도</button>
            <button class="tab" data-category="humidity">습도</button>
        </div>
    </div>

    <!-- 차트 -->
    <section class="chart-container">
        <canvas id="weatherChart"></canvas>
    </section>
</div>

<script>
    const ctx = document.getElementById('weatherChart').getContext('2d')
    const weatherChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: '아두이노', data: [], borderColor: '#007bff', tension: 0.2, pointRadius: 3, spanGaps: false },
                { label: '기상청', data: [], borderColor: '#dc3545', tension: 0.2, pointRadius: 3, spanGaps: false }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                x: { ticks: { maxTicksLimit: 12 } },
                y: { title: { display: true, text: '' } }
            }
        }
    })

    const chartTitleMap = {
        temperature: { title: '온도', unit: '°C' },
        humidity: { title: '습도', unit: '%' }
    }

    async function updateChart(category) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
        const activeTab = document.querySelector(`.tab[data-category="${category}"]`)
        if (activeTab) activeTab.classList.add('active')

        try {
            const resp = await fetch(`/api/chart_data/${category}`)
            const data = await resp.json()
            if (data.error) return

            weatherChart.data.labels = data.labels
            weatherChart.data.datasets[0].data = data.arduino_values
            weatherChart.data.datasets[1].data = data.kma_values

            const meta = chartTitleMap[category]
            weatherChart.options.scales.y.title.text = `${meta.title} ${meta.unit}`
            weatherChart.update()
        } catch (e) {
            console.error('차트 업데이트 실패:', e)
        }
    }

    async function updateCards() {
        try {
            const resp = await fetch('/api/latest-data')
            const data = await resp.json()
            document.getElementById('display-time').textContent = data.display_date

            const a = data.arduino || {}
            const k = data.kma || {}

            document.getElementById('arduino-temp').innerHTML =
                a.temperature != null ? `${a.temperature.toFixed(1)}<span class="unit">°C</span>` : '--°C'
            document.getElementById('kma-temp').innerHTML =
                k.temperature != null ? `${k.temperature.toFixed(1)}<span class="unit">°C</span>` : '--°C'

            document.getElementById('arduino-hum').innerHTML =
                a.humidity != null ? `${a.humidity.toFixed(0)}<span class="unit">%</span>` : '--%'
            document.getElementById('kma-hum').innerHTML =
                k.humidity != null ? `${k.humidity.toFixed(0)}<span class="unit">%</span>` : '--%'

            document.getElementById('arduino-pressure').innerHTML =
                a.pressure != null ? `${a.pressure.toFixed(1)}<span class="unit">hPa</span>` : '-- hPa'
            document.getElementById('kma-pressure').innerHTML =
                k.pressure != null ? `${k.pressure.toFixed(1)}<span class="unit">hPa</span>` : '-- hPa'
        } catch (e) {
            console.error('카드 업데이트 실패:', e)
        }
    }

    async function updateDashboard() {
        await updateCards()
        const active = document.querySelector('.tab.active')
        const category = active ? active.dataset.category : 'temperature'
        await updateChart(category)
    }

    // 탭 클릭
    document.getElementById('tabs').addEventListener('click', e => {
        const tab = e.target.closest('.tab')
        if (!tab) return
        updateChart(tab.dataset.category)
    })

    // 초기 로드  카드는 10초마다  차트는 1분마다
    document.addEventListener('DOMContentLoaded', () => {
        updateDashboard()
        setInterval(updateCards, 10000)
        setInterval(() => {
            const active = document.querySelector('.tab.active')?.dataset.category || 'temperature'
            updateChart(active)
        }, 60000)
    })
</script>
</body>
</html>
