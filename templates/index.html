<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PYDUINO ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
    <!-- í—¤ë” -->
    <header class="header">
        <span>PYDUINO</span>
        <span id="display-time">{{ display_date }}</span>
    </header>

    <!-- ìƒë‹¨ ì¹´ë“œ -->
    <section class="info-cards">
        <div class="card">
            <h3>ì˜¨ë„</h3>
            <p id="arduino-temp" class="value arduino">--Â°C</p>
            <p id="kma-temp" class="value kma">--Â°C</p>
        </div>
        <div class="card">
            <h3>ìŠµë„</h3>
            <p id="arduino-hum" class="value arduino">--%</p>
            <p id="kma-hum" class="value kma">--%</p>
        </div>
        <div class="card">
            <h3>ê¸°ì••</h3>
            <p id="arduino-pressure" class="value arduino">-- hPa</p>
            <p id="kma-pressure" class="value kma">-- hPa</p>
        </div>
    </section>

    <!-- íƒ­ + ì˜¤ì°¨ìœ¨ ë²„íŠ¼ ê·¸ë£¹ -->
    <div class="bar">
        <div class="tabs" id="tabs">
            <button class="tab active" data-category="temperature">ì˜¨ë„</button>
            <button class="tab" data-category="humidity">ìŠµë„</button>
            <button class="tab" data-category="pressure">ê¸°ì••</button>
        </div>

        <div class="error-group" id="errorGroup">
            <button class="error-btn" data-errcat="temperature">ì˜¨ë„</button>
            <button class="error-btn" data-errcat="humidity">ìŠµë„</button>
            <button class="error-btn" data-errcat="pressure">ê¸°ì••</button>
        </div>
    </div>

    <!-- ì°¨íŠ¸ -->
    <section class="chart-container">
        <canvas id="weatherChart"></canvas>
    </section>
</div>

<script>
    const ctx = document.getElementById('weatherChart').getContext('2d')

    const chartTitleMap = {
        temperature: { title: 'ì˜¨ë„', unit: 'Â°C' },
        humidity: { title: 'ìŠµë„', unit: '%' },
        pressure: { title: 'ê¸°ì••', unit: 'hPa' }
    }

    // mode: 'value' ì¼ë°˜ ê·¸ë˜í”„, 'error' ì˜¤ì°¨ ê·¸ë˜í”„
    let mode = 'value'
    let currentCategory = 'temperature' // ì™¼ìª½ íƒ­ì˜ í˜„ì¬ ì„ íƒê°’

    const weatherChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                x: { ticks: { maxTicksLimit: 12 } },
                y: { title: { display: true, text: '' } }
            }
        }
    })

    // ì¼ë°˜ ì„¼ì„œ ê·¸ë˜í”„
    async function updateChart(category) {
    mode = 'value';
    currentCategory = category;

    // ğŸ”¥ íƒ­ ë²„íŠ¼ í™œì„±í™” ì ìš©
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-category="${category}"]`).classList.add('active');

    // ğŸ”¥ ì˜¤ì°¨ ë²„íŠ¼ì€ ëª¨ë‘ ë¹„í™œì„±í™”
    document.querySelectorAll('.error-btn').forEach(b => b.classList.remove('active'));

    // ê·¸ë˜í”„ íƒ€ì…ì€ ë¼ì¸ìœ¼ë¡œ ë³µê·€
    weatherChart.config.type = 'line';

    const resp = await fetch(`/api/chart_data/${category}`);
    const data = await resp.json();

    weatherChart.data.labels = data.labels;
    weatherChart.data.datasets = [
        {
            label: 'ì•„ë‘ì´ë…¸',
            data: data.arduino_values,
            borderColor: '#007bff',
            tension: 0.2,
            pointRadius: 2
        },
        {
            label: 'ê¸°ìƒì²­',
            data: data.kma_values,
            borderColor: '#dc3545',
            tension: 0.2,
            pointRadius: 2
        }
    ];

    const meta = chartTitleMap[category];
    weatherChart.options.scales.y.title.text = `${meta.title} ${meta.unit}`;

    weatherChart.update();
}



    // ì¹´í…Œê³ ë¦¬ë³„ ì˜¤ì°¨ìœ¨ ê·¸ë˜í”„
    async function updateErrorChart(errCat) {
        mode = 'error';

        // ë²„íŠ¼ UI ìƒíƒœ ê°±ì‹ 
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.error-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.error-btn[data-errcat="${errCat}"]`).classList.add('active');

        // API í˜¸ì¶œ
        const resp = await fetch(`/api/error_data/${errCat}`);
        const data = await resp.json();
        if (data.error) return;

        // ğŸ”¥ ì°¨íŠ¸ íƒ€ì…ì„ ë§‰ëŒ€(bar)ë¡œ ë³€ê²½
        weatherChart.config.type = 'bar';

        weatherChart.data.labels = data.labels;
        weatherChart.data.datasets = [
            {
                label: `${chartTitleMap[errCat].title} ì˜¤ì°¨ìœ¨`,
                data: data.errors,
                backgroundColor: 'rgba(111, 66, 193, 0.6)',
                borderColor: '#6f42c1',
                borderWidth: 1
            }
        ];

        weatherChart.options.scales.y.title.text = 'ì˜¤ì°¨ìœ¨ %';

        weatherChart.update();
    }


    // ì¹´ë“œ ì—…ë°ì´íŠ¸
    async function updateCards() {
        try {
            const resp = await fetch('/api/latest-data')
            const data = await resp.json()

            document.getElementById('display-time').textContent = data.display_date

            const a = data.arduino || {}
            const k = data.kma || {}

            document.getElementById('arduino-temp').innerHTML =
                a.temperature != null ? `${a.temperature.toFixed(1)}<span class="unit">Â°C</span>` : '--Â°C'
            document.getElementById('kma-temp').innerHTML =
                k.temperature != null ? `${k.temperature.toFixed(1)}<span class="unit">Â°C</span>` : '--Â°C'

            document.getElementById('arduino-hum').innerHTML =
                a.humidity != null ? `${a.humidity.toFixed(0)}<span class="unit">%</span>` : '--%'
            document.getElementById('kma-hum').innerHTML =
                k.humidity != null ? `${k.humidity.toFixed(0)}<span class="unit">%</span>` : '--%'

            document.getElementById('arduino-pressure').innerHTML =
                a.pressure != null ? `${a.pressure.toFixed(1)}<span class="unit">hPa</span>` : '-- hPa'
            document.getElementById('kma-pressure').innerHTML =
                k.pressure != null ? `${k.pressure.toFixed(1)}<span class="unit">hPa</span>` : '-- hPa'
        } catch(e) {
            console.error('ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e)
        }
    }

    // ì£¼ê¸° ê°±ì‹ 
    function refreshActive() {
        if (mode === 'error') {
            const activeErr = document.querySelector('.error-btn.active')?.dataset.errcat || 'temperature'
            updateErrorChart(activeErr)
        } else {
            updateChart(currentCategory)
        }
    }

    // ì´ë²¤íŠ¸
    document.getElementById('tabs').addEventListener('click', e => {
        const tab = e.target.closest('.tab')
        if (!tab) return
        updateChart(tab.dataset.category)
    })

    document.getElementById('errorGroup').addEventListener('click', e => {
        const btn = e.target.closest('.error-btn')
        if (!btn) return
        updateErrorChart(btn.dataset.errcat)
    })

    document.addEventListener('DOMContentLoaded', () => {
        updateCards()
        updateChart('temperature')
        setInterval(updateCards, 10000)
        setInterval(refreshActive, 60000)
    })
</script>
</body>
</html>
